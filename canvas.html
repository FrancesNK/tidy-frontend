<html>
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
<head>
    <script>
        window.onload = function() {
            draw();
            var saveButton = document.getElementById("saveImageBtn");
            bindButtonEvent(saveButton, "click", saveImageInfo);
            var dlButton = document.getElementById("downloadImageBtn");
            bindButtonEvent(dlButton, "click", saveAsLocalImage);
        };
        function draw(){
            var canvas = document.getElementById("thecanvas");
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = "rgba(125, 46, 138, 0.5)";
            ctx.fillRect(25,25,100,100);
            ctx.fillStyle = "rgba( 0, 146, 38, 0.5)";
            ctx.fillRect(58, 74, 125, 100);
            ctx.fillStyle = "rgba( 0, 0, 0, 1)"; // black color
            ctx.fillText("Gloomyfish - Demo", 50, 50);
        }

        function bindButtonEvent(element, type, handler)
        {
            if(element.addEventListener) {
                element.addEventListener(type, handler, false);
            } else {
                element.attachEvent('on'+type, handler);
            }
        }

        function saveImageInfo ()
        {
            var mycanvas = document.getElementById("thecanvas");
            var image    = mycanvas.toDataURL("image/png");
            var w=window.open('about:blank','image from canvas');
            w.document.write("<img src='"+image+"' alt='from canvas'/>");
        }

        function saveAsLocalImage () {
            var myCanvas = document.getElementById("thecanvas");
            // here is the most important part because if you dont replace you will get a DOM 18 exception.
            // var image = myCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream;Content-Disposition: attachment;filename=foobar.png");
            var image = myCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
            window.location.href=image; // it will save locally
        }
        $(document).ready(function(){
            $('#file').change(function(){
                var file = this.files[0];
                var img = new Image();
                img.onload = function() {
                    //生成比例
                    var width = img.width,
                            height = img.height,
                            scale = width / height;
                    width = parseInt(800);
                    height = parseInt(width / scale);

                    //生成canvas
                    canvas = document.createElement("canvas");
                    var ctx = canvas.getContext("2d");
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    var base64 = canvas.toDataURL('image/png',0.8);

                    var w=window.open('about:blank','image from canvas');
                    w.document.write("<img src='"+base64+"' alt='from canvas'/>");
                    console.log(base64);
                    //发送到服务端
                    //$.post('upload.php',{formFile : base64.substr(22) },function(data){
                    //    $('#php').html(data);
                    //});
                };
                var reader = new FileReader();
                reader.onload = function() {
                    //读取到的文件内容.这个属性只在读取操作完成之后才有效,并且数据的格式取决于读取操作是由哪个方法发起的.所以必须使用reader.onload
                    var url = reader.result;
                    //reader读取的文件内容是base64,利用这个url就能实现上传前预览图片
                    img.src=url;
                    console.log(url);
                };
                reader.readAsDataURL(file);
            });
        });
    </script>
</head>
<body bgcolor="#E6E6FA">
<div>
    <canvas width=200 height=200 id="thecanvas"></canvas>
    <button id="saveImageBtn">Save Image</button>
    <button id="downloadImageBtn">Download Image</button>
    <br/>
    <form>
        <input id="file" type="file" accept="image/*" name="file" />
    </form>
    <cancas id="canvas"></cancas>
</div>
</body>
</html>