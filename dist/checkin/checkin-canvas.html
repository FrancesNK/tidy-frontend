<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><title>签到</title><link rel="stylesheet" href="//cdn.bootcss.com/semantic-ui/2.1.8/semantic.min.css"><script src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><script src="//cdn.bootcss.com/semantic-ui/2.1.8/semantic.min.js"></script><script src="//cdn.bootcss.com/lodash.js/4.9.0/lodash.min.js"></script><script src="../static/jwt-decode.min.js"></script><script src="//cdn.bootcss.com/js-cookie/2.1.0/js.cookie.js"></script><script src="../auth/auth.js"></script><script>function dataURLtoBlob(i){for(var e=i.split(","),o=e[0].match(/:(.*?);/)[1],a=atob(e[1]),t=a.length,n=new Uint8Array(t);t--;)n[t]=a.charCodeAt(t);return new Blob([n],{type:o})}$(document).ready(function(){$(".ui.message").hide(),$("#row2").hide(),$("#file").hide();var e=new Array,o=-1;Cookies.set("imgurl_prefix","https://api.ctidy.com/v1/static/images/"),$("#checkin").click(function(){$("#chkcnt").attr("readonly","readonly"),$("#checking").removeClass("inactive").addClass("active");var a=$("#chkcnt").val();if(console.log(a),img="",console.log(e),-1!=o)for(img=e[0].guid+"."+e[0].ext,i=1;i<=o;i++)img+="|"+e[i].guid+"."+e[i].ext;console.log("img: "+img),$.ajax({url:"https://api.ctidy.com/v1/checkin",dataType:"json",type:"POST",data:{auth_token:Cookies.get("auth_token"),content:a,img:img},success:function(i){console.log(i),window.location.href="../user/index.html",$(".ui.success.message").show()},statusCode:{403:function(){$(".ui.error.message.1").hide(),$(".ui.error.message.2").show(),setTimeout(function(){window.location.href="../user/index.html"},3e3)}},error:function(i){console.log(i),$(".ui.error.message.1").show(),setTimeout(function(){$(".ui.error.message.1").hide()},3e3)}}),$("#checking").addClass("inactive").removeClass("active"),$("#chkcnt").removeAttr("readonly")}),$("#upload").click(function(){$("#file").click()}),$("#file").change(function(i){console.log("file select clicked");var a=this.files[0],t=new Image;t.onload=function(){var i=t.width,a=t.height,n=i/a;i=parseInt(800),a=parseInt(i/n),canvas=document.createElement("canvas");var d=canvas.getContext("2d");canvas.width=i,canvas.height=a,d.drawImage(t,0,0,i,a);var l=canvas.toDataURL("image/png",.8);console.log(l);var r=dataURLtoBlob(l),s=new FormData;if(s.append("file",r,"image.png"),!(o+2>4)){var c='<div id="<%= divid %>" class="ui column small rounded image upload-img"><img id="<%= imgid %>" class="rounded" src="<%= imgurl %>"><div class="ui upload-img-del"><i class="large grey remove circle link icon"></i></div></div>',g=_.template(c);$.ajax({url:"https://api.ctidy.com/v1/user/uploadimg",type:"POST",data:s,cache:!1,contentType:!1,enctype:"multipart/form-data",processData:!1,success:function(i){o++,e[o]={guid:i.guid,ext:i.ext},console.log(i),console.log(e),divid="div"+e[o].guid,imgid="img"+e[o].guid,imgurl=Cookies.get("imgurl_prefix")+e[o].guid+"."+e[o].ext,rowid="#row1",o+1>2&&(rowid="#row2"),$(rowid).append(g({divid:divid,imgid:imgid,imgurl:imgurl})).show(),$("#"+divid).show()}})}};var n=new FileReader;n.onload=function(){var i=n.result;t.src=i,console.log(i)},n.readAsDataURL(a)}),$("form").submit(function(i){if(i.preventDefault(),!(o+2>4)){var a=new FormData($(this)[0]),t='<div id="<%= divid %>" class="ui column small rounded image upload-img"><img id="<%= imgid %>" class="rounded" src="<%= imgurl %>"><div class="ui upload-img-del"><i class="large grey remove circle link icon"></i></div></div>',n=_.template(t);return console.log(a),$.ajax({url:"https://api.ctidy.com/v1/user/uploadimg",type:"POST",data:a,cache:!1,contentType:!1,enctype:"multipart/form-data",processData:!1,success:function(i){o++,e[o]={guid:i.guid,ext:i.ext},console.log(i),console.log(e),divid="div"+e[o].guid,imgid="img"+e[o].guid,imgurl=Cookies.get("imgurl_prefix")+e[o].guid+"."+e[o].ext,rowid="#row1",o+1>2&&(rowid="#row2"),$(rowid).append(n({divid:divid,imgid:imgid,imgurl:imgurl})).show(),$("#"+divid).show()}}),!1}})})</script></head><body><div id="ciform" class="ui form"><div class="field"><label><h3>签到内容</h3></label><textarea id="chkcnt" placeholder="点此输入签到内容"></textarea></div><div id="cigrid" class="ui equal width grid" style="margin:-5px"><div id="row1" class="row"></div><div id="row2" class="row"></div></div></div><div class="ui center aligned container"><div id="upload" class="ui basic button"><i class="icon photo"></i> 上图</div><div id="checkin" class="ui basic button"><i class="icon edit"></i> 签到</div><div id="checking" class="ui inactive inverted dimmer"><div class="ui medium text loader">签到中</div></div><div class="ui success message"><div class="content"><div class="header">签到成功!<br>马上跳转到个人首页!</div></div></div><div class="ui error message 1"><div class="content"><div class="header">签到失败!请重试!</div></div></div><div class="ui error message 2"><div class="content"><div class="header">每天只能签到一次哦!<br>马上跳转到个人首页!</div></div></div></div><form><input id="file" type="file" accept="image/*" name="file"></form><div id="lrz"><img id="lrzimg" src=""></div><br><br><br><br><br><div class="ui tiny bottom fixed inverted menu three labeled icon item"><a class="item" href="../user/index.html"><i class="home icon"></i> 首页 </a><a class="active item" href="../checkin/index.html"><i class="edit icon"></i> 签到 </a><a class="item" href="../checkin/index.html"><i class="checkmark box icon"></i> 记录</a></div></body><style>.ui.form{margin:10px}.ui.input{margin:10px}#label{margin-left:10px}.upload-img{position:relative}.upload-img-del{position:absolute;right:-1px;bottom:-6px}</style></html>