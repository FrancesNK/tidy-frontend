<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0">
        <title>签到记录</title>
        <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/semantic-ui/2.1.8/semantic.min.css">
        <script type="application/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js" ></script>
        <script type="application/javascript" src="//cdn.bootcss.com/semantic-ui/2.1.8/semantic.min.js"></script>
        <script type="application/javascript" src="//cdn.bootcss.com/lodash.js/4.9.0/lodash.min.js"></script>
        <script type="application/javascript" src="//cdn.bootcss.com/js-cookie/2.1.0/js.cookie.js"></script>
        <script type="application/javascript" src="../static/js/jwt-decode.min.js"></script>
        <script type="application/javascript" src="../auth/auth.js"></script>
        <script type="application/javascript" src="../system/feedback.js"></script>
        <script type="application/javascript" src="../static/js/htmlescape.js"></script>
        <script type="application/javascript">
            $(document).ready(function(){
                var auth_token = Cookies.get('auth_token');
                var user_info = Cookies.getJSON('user_info');
                Cookies.set('imgurl', 'http://127.0.0.1:8089/v1/static/images/');
                var card_tmpl = '';
                var list_type = {
                    PERSONAL: 0,
                    ALL: 1,
                    SPECIAL: 2
                };
                var cur_type = list_type.PERSONAL;
                $('#user').click(function () {
                    $('#user').addClass('active');
                    $('#users').removeClass('active');
                    cur_type = list_type.PERSONAL;
                    reload_func();
                });

                $('#users').click(function () {
                    $('#users').addClass('active');
                    $('#user').removeClass('active');
                    cur_type = list_type.ALL;
                    reload_func();
                });

                $.get('../templates/card-checkin.tmpl', function(data) {
                    card_tmpl = data;
                }).fail(function(jqXHR) {
                    $('#container').html('An error occurred: ' + jqXHR.status).append(jqXHR.responseText);
                });

                var reload_func = function () {
                    $('#container').empty();
                    last_timestamp = parseInt(Date.parse(new Date())/1000);
                    check_and_load();
                };
                var check_and_load = function () {
                    if(card_tmpl != "") {
                        load_func();
                    } else {
                        console.log('card_tmpl is empty, waiting ...');
                        setTimeout(check_and_load, 8);
                    }
                };
                var last_timestamp = parseInt(Date.parse(new Date())/1000);
                var cnt = 32;
                var load_func = function () {
                    console.info('TBD...paging...');
                    $.ajax({
                        url: 'http://127.0.0.1:8089/v1/checkin',
                        dataType: 'jsonp',
                        //type: 'POST',
                        data: {
                            auth_token: auth_token,
                            type: cur_type,
                            timestamp: last_timestamp,
                            count: cnt
                        },
                        success: function(res) {
                            var tmpl = _.template(card_tmpl);
                            var sorted = _.sortBy(res.data, ['timestamp']);
                            if(sorted.length == 0){
                                console.log('no data!');
                                return;
                            }
                            console.log(sorted);
                            last_timestamp = sorted[0].timestamp;
                            //console.log(last_timestamp);
                            for(var i = sorted.length - 1; i >= 0; i --) {
                                var c = sorted[i]
                                if(c.create_hour < 10){
                                    c.create_hour = '0' + c.create_hour
                                }
                                if(c.create_min < 10){
                                    c.create_min = '0' + c.create_min
                                }
                                if(c.create_sec < 10){
                                    c.create_sec = '0' + c.create_sec
                                }
                                var date = c.create_year + '年' + c.create_month + '月' + c.create_day + '日' + ' ' + c.create_hour + ":" + c.create_min + ":" + c.create_sec;
                                var html = tmpl({
                                    'cuid': user_info.uid,
                                    'uid': c.user_id,
                                    'user_name': htmlEscape(c.user_name),
                                    'content': htmlEscape(c.content),
                                    'date': date,
                                    'imgurl': Cookies.get('imgurl'),
                                    'imgs': c.images
                                });
                                //console.log(html);
                                $('#container').append($(html));
                            }
                        }
                    });
                };
                //reload_func();
                $('#container')
                    .visibility({
                        once: false,
                        observeChanges: true,
                        onBottomVisible: function() {
                            check_and_load();
                        }
                    })
                ;
            });
        </script>
    </head>
    <body>
        <!--
        <a class="ui tag label" style="position: fixed; bottom: 64px; right: 0px; z-index: 1;">问题反馈</a>
        -->
        <br/>
        <div id="container" class="ui container">
        </div>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <div class="ui tiny bottom fixed inverted menu four labeled icon item">
            <a class="item" href="../user/index.html">
                <i class="home icon"></i>
                首页
            </a>
            <a id="user" class="active item">
                <i class="checkmark box icon"></i>
                签到记录
            </a>
            <a id="users" class="item">
                <i class="users icon"></i>
                广场
            </a>
            <a id="feedback" class="item">
                <i class="bug icon"></i>
                问题反馈
            </a>
        </div>
    </body>
</html>
